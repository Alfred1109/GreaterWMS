# GreaterWMS 数据库备份策略

## 📋 概述

本文档为GreaterWMS仓库管理系统提供完整的数据库备份策略，包括备份方案、实施方法和恢复流程。

---

## 🎯 备份目标

### 数据保护目标
- **RTO (恢复时间目标)**: ≤ 30分钟
- **RPO (恢复点目标)**: ≤ 1小时  
- **数据完整性**: 99.99%
- **可用性**: 99.9%

### 备份范围
- 主数据库文件：`db.sqlite3`
- 媒体文件：`media/` 目录
- 配置文件：关键配置文件
- 日志文件：重要操作日志

---

## 🗂️ 备份分类策略

### 1. 全量备份 (Full Backup)
- **频率**: 每日凌晨 2:00
- **保留期**: 30天
- **存储位置**: `backups/full/`
- **命名规则**: `full_backup_YYYYMMDD_HHMMSS.sqlite3`

### 2. 增量备份 (Incremental Backup) 
- **频率**: 每小时
- **保留期**: 7天  
- **存储位置**: `backups/incremental/`
- **命名规则**: `inc_backup_YYYYMMDD_HHMMSS.sqlite3`

### 3. 热备份 (Hot Backup)
- **触发条件**: 重要操作前自动执行
- **保留期**: 3天
- **存储位置**: `backups/hot/`
- **命名规则**: `hot_backup_YYYYMMDD_HHMMSS.sqlite3`

---

## 🔧 实施方案

### 1. 管理命令
```bash
# 执行全量备份
python manage.py db_backup --type=full

# 执行增量备份  
python manage.py db_backup --type=incremental

# 执行热备份
python manage.py db_backup --type=hot

# 清理过期备份
python manage.py db_backup --cleanup

# 验证备份文件
python manage.py db_backup --verify=backups/full/full_backup_20240101_020000.sqlite3
```

### 2. 恢复命令
```bash
# 从备份恢复数据库
python manage.py db_restore --file=backups/full/full_backup_20240101_020000.sqlite3

# 列出可用备份
python manage.py db_restore --list

# 验证恢复后数据库
python manage.py db_restore --verify
```

---

## 📁 目录结构

```
GreaterWMS/
├── backups/
│   ├── full/                    # 全量备份目录
│   │   ├── full_backup_20240101_020000.sqlite3
│   │   └── ...
│   ├── incremental/             # 增量备份目录
│   │   ├── inc_backup_20240101_030000.sqlite3
│   │   └── ...
│   ├── hot/                     # 热备份目录
│   │   ├── hot_backup_20240101_143000.sqlite3
│   │   └── ...
│   └── logs/                    # 备份日志目录
│       ├── backup.log
│       └── restore.log
├── db.sqlite3                   # 主数据库
└── media/                       # 媒体文件目录
```

---

## 🔒 安全策略

### 1. 权限控制
- 备份目录权限：`700 (rwx------)`
- 备份文件权限：`600 (rw-------)`
- 仅系统管理员可访问备份文件

### 2. 加密存储
- 敏感备份文件使用AES-256加密
- 密钥独立存储和管理
- 传输过程使用SSL/TLS加密

### 3. 访问审计
- 记录所有备份和恢复操作
- 监控异常访问行为
- 定期审查访问日志

---

## 🚀 自动化配置

### 1. Crontab配置（Linux系统）
```bash
# 编辑crontab
crontab -e

# 添加定时任务
# 每日凌晨2点全量备份
0 2 * * * /path/to/venv/bin/python /path/to/GreaterWMS/manage.py db_backup --type=full >> /var/log/greaterwms_backup.log 2>&1

# 每小时增量备份（工作时间）
0 9-18 * * 1-5 /path/to/venv/bin/python /path/to/GreaterWMS/manage.py db_backup --type=incremental >> /var/log/greaterwms_backup.log 2>&1

# 每周日清理过期备份
0 3 * * 0 /path/to/venv/bin/python /path/to/GreaterWMS/manage.py db_backup --cleanup >> /var/log/greaterwms_backup.log 2>&1
```

### 2. Windows计划任务
```batch
# 创建批处理脚本 backup_full.bat
@echo off
cd /d "C:\path\to\GreaterWMS"
C:\path\to\venv\Scripts\python.exe manage.py db_backup --type=full
echo Backup completed at %date% %time% >> backup.log

# 使用schtasks命令创建计划任务
schtasks /create /tn "GreaterWMS Full Backup" /tr "C:\path\to\backup_full.bat" /sc daily /st 02:00
```

### 3. Docker环境配置
```yaml
# docker-compose.yml 添加备份服务
version: '3.9'
services:
  backup-cron:
    image: greaterwms/greaterwms:backend
    container_name: greaterwms_backup
    volumes:
      - ./:/GreaterWMS/:rw
      - ./backups:/GreaterWMS/backups:rw
    environment:
      - PYTHONUNBUFFERED=1
    command: >
      sh -c "
        echo '0 2 * * * cd /GreaterWMS && python manage.py db_backup --type=full' | crontab -
        && echo '0 */4 * * * cd /GreaterWMS && python manage.py db_backup --type=incremental' | crontab -
        && echo '0 3 * * 0 cd /GreaterWMS && python manage.py db_backup --cleanup' | crontab -
        && crond -f
      "
```

---

## 🔍 监控和告警

### 1. 备份状态监控
- 备份任务执行状态监控
- 备份文件大小异常检测
- 备份失败自动告警

### 2. 告警配置
```python
# 邮件告警设置
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'your-email@gmail.com'
EMAIL_HOST_PASSWORD = 'your-password'
BACKUP_ALERT_EMAILS = ['admin@company.com', 'dba@company.com']
```

### 3. 日志分析
- 定期分析备份日志
- 识别潜在问题和趋势
- 优化备份性能

---

## 📊 测试和验证

### 1. 备份验证
```bash
# 验证备份文件完整性
python manage.py db_backup --verify=backups/full/full_backup_20240101_020000.sqlite3

# 验证备份数据一致性
python manage.py db_backup --validate-data=backups/full/full_backup_20240101_020000.sqlite3
```

### 2. 恢复测试
```bash
# 创建测试环境
python manage.py db_restore --file=backups/full/full_backup_20240101_020000.sqlite3 --test-mode

# 验证恢复后数据完整性
python manage.py db_restore --verify --test-mode
```

### 3. 灾难恢复演练
- **频率**: 每季度一次
- **范围**: 完整的数据恢复流程
- **文档**: 记录演练结果和改进建议

---

## 🏢 生产环境建议

### 1. 数据库升级
- **推荐**: PostgreSQL 13+ 或 MySQL 8.0+
- **优势**: 更好的并发性能和备份功能
- **迁移**: 提供数据迁移脚本

### 2. 分布式备份
- 多地域备份策略
- 云存储集成（AWS S3、阿里云OSS等）
- 跨数据中心同步

### 3. 高可用架构
- 主从复制配置
- 读写分离部署
- 自动故障转移

---

## 🆘 应急恢复流程

### 1. 故障评估
1. 确认故障类型和影响范围
2. 评估数据丢失程度
3. 选择合适的恢复策略

### 2. 快速恢复
```bash
# 停止应用服务
sudo systemctl stop nginx
sudo systemctl stop supervisor

# 备份当前损坏文件
mv db.sqlite3 db.sqlite3.damaged_$(date +%Y%m%d_%H%M%S)

# 恢复最新备份
python manage.py db_restore --file=backups/full/latest_backup.sqlite3

# 验证数据完整性
python manage.py db_restore --verify

# 重启服务
sudo systemctl start supervisor
sudo systemctl start nginx
```

### 3. 后续处理
1. 分析故障原因
2. 更新备份策略
3. 加强预防措施

---

## 📞 联系信息

**运维团队**: ops@greaterwms.com  
**技术支持**: tech@greaterwms.com  
**紧急联系**: +86-xxx-xxxx-xxxx

---

## 📝 变更记录

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| 1.0 | 2024-01-01 | 初始版本 | Admin |
| 1.1 | 2024-02-01 | 添加Docker配置 | DevOps |
| 1.2 | 2024-03-01 | 完善监控告警 | SRE |

---

*最后更新: 2024年1月*  
*维护者: GreaterWMS运维团队*
