# GreaterWMS æ•°æ®åº“å¤‡ä»½ç­–ç•¥

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£ä¸ºGreaterWMSä»“åº“ç®¡ç†ç³»ç»Ÿæä¾›å®Œæ•´çš„æ•°æ®åº“å¤‡ä»½ç­–ç•¥ï¼ŒåŒ…æ‹¬å¤‡ä»½æ–¹æ¡ˆã€å®æ–½æ–¹æ³•å’Œæ¢å¤æµç¨‹ã€‚

---

## ğŸ¯ å¤‡ä»½ç›®æ ‡

### æ•°æ®ä¿æŠ¤ç›®æ ‡
- **RTO (æ¢å¤æ—¶é—´ç›®æ ‡)**: â‰¤ 30åˆ†é’Ÿ
- **RPO (æ¢å¤ç‚¹ç›®æ ‡)**: â‰¤ 1å°æ—¶  
- **æ•°æ®å®Œæ•´æ€§**: 99.99%
- **å¯ç”¨æ€§**: 99.9%

### å¤‡ä»½èŒƒå›´
- ä¸»æ•°æ®åº“æ–‡ä»¶ï¼š`db.sqlite3`
- åª’ä½“æ–‡ä»¶ï¼š`media/` ç›®å½•
- é…ç½®æ–‡ä»¶ï¼šå…³é”®é…ç½®æ–‡ä»¶
- æ—¥å¿—æ–‡ä»¶ï¼šé‡è¦æ“ä½œæ—¥å¿—

---

## ğŸ—‚ï¸ å¤‡ä»½åˆ†ç±»ç­–ç•¥

### 1. å…¨é‡å¤‡ä»½ (Full Backup)
- **é¢‘ç‡**: æ¯æ—¥å‡Œæ™¨ 2:00
- **ä¿ç•™æœŸ**: 30å¤©
- **å­˜å‚¨ä½ç½®**: `backups/full/`
- **å‘½åè§„åˆ™**: `full_backup_YYYYMMDD_HHMMSS.sqlite3`

### 2. å¢é‡å¤‡ä»½ (Incremental Backup) 
- **é¢‘ç‡**: æ¯å°æ—¶
- **ä¿ç•™æœŸ**: 7å¤©  
- **å­˜å‚¨ä½ç½®**: `backups/incremental/`
- **å‘½åè§„åˆ™**: `inc_backup_YYYYMMDD_HHMMSS.sqlite3`

### 3. çƒ­å¤‡ä»½ (Hot Backup)
- **è§¦å‘æ¡ä»¶**: é‡è¦æ“ä½œå‰è‡ªåŠ¨æ‰§è¡Œ
- **ä¿ç•™æœŸ**: 3å¤©
- **å­˜å‚¨ä½ç½®**: `backups/hot/`
- **å‘½åè§„åˆ™**: `hot_backup_YYYYMMDD_HHMMSS.sqlite3`

---

## ğŸ”§ å®æ–½æ–¹æ¡ˆ

### 1. ç®¡ç†å‘½ä»¤
```bash
# æ‰§è¡Œå…¨é‡å¤‡ä»½
python manage.py db_backup --type=full

# æ‰§è¡Œå¢é‡å¤‡ä»½  
python manage.py db_backup --type=incremental

# æ‰§è¡Œçƒ­å¤‡ä»½
python manage.py db_backup --type=hot

# æ¸…ç†è¿‡æœŸå¤‡ä»½
python manage.py db_backup --cleanup

# éªŒè¯å¤‡ä»½æ–‡ä»¶
python manage.py db_backup --verify=backups/full/full_backup_20240101_020000.sqlite3
```

### 2. æ¢å¤å‘½ä»¤
```bash
# ä»å¤‡ä»½æ¢å¤æ•°æ®åº“
python manage.py db_restore --file=backups/full/full_backup_20240101_020000.sqlite3

# åˆ—å‡ºå¯ç”¨å¤‡ä»½
python manage.py db_restore --list

# éªŒè¯æ¢å¤åæ•°æ®åº“
python manage.py db_restore --verify
```

---

## ğŸ“ ç›®å½•ç»“æ„

```
GreaterWMS/
â”œâ”€â”€ backups/
â”‚   â”œâ”€â”€ full/                    # å…¨é‡å¤‡ä»½ç›®å½•
â”‚   â”‚   â”œâ”€â”€ full_backup_20240101_020000.sqlite3
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ incremental/             # å¢é‡å¤‡ä»½ç›®å½•
â”‚   â”‚   â”œâ”€â”€ inc_backup_20240101_030000.sqlite3
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ hot/                     # çƒ­å¤‡ä»½ç›®å½•
â”‚   â”‚   â”œâ”€â”€ hot_backup_20240101_143000.sqlite3
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ logs/                    # å¤‡ä»½æ—¥å¿—ç›®å½•
â”‚       â”œâ”€â”€ backup.log
â”‚       â””â”€â”€ restore.log
â”œâ”€â”€ db.sqlite3                   # ä¸»æ•°æ®åº“
â””â”€â”€ media/                       # åª’ä½“æ–‡ä»¶ç›®å½•
```

---

## ğŸ”’ å®‰å…¨ç­–ç•¥

### 1. æƒé™æ§åˆ¶
- å¤‡ä»½ç›®å½•æƒé™ï¼š`700 (rwx------)`
- å¤‡ä»½æ–‡ä»¶æƒé™ï¼š`600 (rw-------)`
- ä»…ç³»ç»Ÿç®¡ç†å‘˜å¯è®¿é—®å¤‡ä»½æ–‡ä»¶

### 2. åŠ å¯†å­˜å‚¨
- æ•æ„Ÿå¤‡ä»½æ–‡ä»¶ä½¿ç”¨AES-256åŠ å¯†
- å¯†é’¥ç‹¬ç«‹å­˜å‚¨å’Œç®¡ç†
- ä¼ è¾“è¿‡ç¨‹ä½¿ç”¨SSL/TLSåŠ å¯†

### 3. è®¿é—®å®¡è®¡
- è®°å½•æ‰€æœ‰å¤‡ä»½å’Œæ¢å¤æ“ä½œ
- ç›‘æ§å¼‚å¸¸è®¿é—®è¡Œä¸º
- å®šæœŸå®¡æŸ¥è®¿é—®æ—¥å¿—

---

## ğŸš€ è‡ªåŠ¨åŒ–é…ç½®

### 1. Crontabé…ç½®ï¼ˆLinuxç³»ç»Ÿï¼‰
```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ å®šæ—¶ä»»åŠ¡
# æ¯æ—¥å‡Œæ™¨2ç‚¹å…¨é‡å¤‡ä»½
0 2 * * * /path/to/venv/bin/python /path/to/GreaterWMS/manage.py db_backup --type=full >> /var/log/greaterwms_backup.log 2>&1

# æ¯å°æ—¶å¢é‡å¤‡ä»½ï¼ˆå·¥ä½œæ—¶é—´ï¼‰
0 9-18 * * 1-5 /path/to/venv/bin/python /path/to/GreaterWMS/manage.py db_backup --type=incremental >> /var/log/greaterwms_backup.log 2>&1

# æ¯å‘¨æ—¥æ¸…ç†è¿‡æœŸå¤‡ä»½
0 3 * * 0 /path/to/venv/bin/python /path/to/GreaterWMS/manage.py db_backup --cleanup >> /var/log/greaterwms_backup.log 2>&1
```

### 2. Windowsè®¡åˆ’ä»»åŠ¡
```batch
# åˆ›å»ºæ‰¹å¤„ç†è„šæœ¬ backup_full.bat
@echo off
cd /d "C:\path\to\GreaterWMS"
C:\path\to\venv\Scripts\python.exe manage.py db_backup --type=full
echo Backup completed at %date% %time% >> backup.log

# ä½¿ç”¨schtaskså‘½ä»¤åˆ›å»ºè®¡åˆ’ä»»åŠ¡
schtasks /create /tn "GreaterWMS Full Backup" /tr "C:\path\to\backup_full.bat" /sc daily /st 02:00
```

### 3. Dockerç¯å¢ƒé…ç½®
```yaml
# docker-compose.yml æ·»åŠ å¤‡ä»½æœåŠ¡
version: '3.9'
services:
  backup-cron:
    image: greaterwms/greaterwms:backend
    container_name: greaterwms_backup
    volumes:
      - ./:/GreaterWMS/:rw
      - ./backups:/GreaterWMS/backups:rw
    environment:
      - PYTHONUNBUFFERED=1
    command: >
      sh -c "
        echo '0 2 * * * cd /GreaterWMS && python manage.py db_backup --type=full' | crontab -
        && echo '0 */4 * * * cd /GreaterWMS && python manage.py db_backup --type=incremental' | crontab -
        && echo '0 3 * * 0 cd /GreaterWMS && python manage.py db_backup --cleanup' | crontab -
        && crond -f
      "
```

---

## ğŸ” ç›‘æ§å’Œå‘Šè­¦

### 1. å¤‡ä»½çŠ¶æ€ç›‘æ§
- å¤‡ä»½ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ç›‘æ§
- å¤‡ä»½æ–‡ä»¶å¤§å°å¼‚å¸¸æ£€æµ‹
- å¤‡ä»½å¤±è´¥è‡ªåŠ¨å‘Šè­¦

### 2. å‘Šè­¦é…ç½®
```python
# é‚®ä»¶å‘Šè­¦è®¾ç½®
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'your-email@gmail.com'
EMAIL_HOST_PASSWORD = 'your-password'
BACKUP_ALERT_EMAILS = ['admin@company.com', 'dba@company.com']
```

### 3. æ—¥å¿—åˆ†æ
- å®šæœŸåˆ†æå¤‡ä»½æ—¥å¿—
- è¯†åˆ«æ½œåœ¨é—®é¢˜å’Œè¶‹åŠ¿
- ä¼˜åŒ–å¤‡ä»½æ€§èƒ½

---

## ğŸ“Š æµ‹è¯•å’ŒéªŒè¯

### 1. å¤‡ä»½éªŒè¯
```bash
# éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
python manage.py db_backup --verify=backups/full/full_backup_20240101_020000.sqlite3

# éªŒè¯å¤‡ä»½æ•°æ®ä¸€è‡´æ€§
python manage.py db_backup --validate-data=backups/full/full_backup_20240101_020000.sqlite3
```

### 2. æ¢å¤æµ‹è¯•
```bash
# åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
python manage.py db_restore --file=backups/full/full_backup_20240101_020000.sqlite3 --test-mode

# éªŒè¯æ¢å¤åæ•°æ®å®Œæ•´æ€§
python manage.py db_restore --verify --test-mode
```

### 3. ç¾éš¾æ¢å¤æ¼”ç»ƒ
- **é¢‘ç‡**: æ¯å­£åº¦ä¸€æ¬¡
- **èŒƒå›´**: å®Œæ•´çš„æ•°æ®æ¢å¤æµç¨‹
- **æ–‡æ¡£**: è®°å½•æ¼”ç»ƒç»“æœå’Œæ”¹è¿›å»ºè®®

---

## ğŸ¢ ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. æ•°æ®åº“å‡çº§
- **æ¨è**: PostgreSQL 13+ æˆ– MySQL 8.0+
- **ä¼˜åŠ¿**: æ›´å¥½çš„å¹¶å‘æ€§èƒ½å’Œå¤‡ä»½åŠŸèƒ½
- **è¿ç§»**: æä¾›æ•°æ®è¿ç§»è„šæœ¬

### 2. åˆ†å¸ƒå¼å¤‡ä»½
- å¤šåœ°åŸŸå¤‡ä»½ç­–ç•¥
- äº‘å­˜å‚¨é›†æˆï¼ˆAWS S3ã€é˜¿é‡Œäº‘OSSç­‰ï¼‰
- è·¨æ•°æ®ä¸­å¿ƒåŒæ­¥

### 3. é«˜å¯ç”¨æ¶æ„
- ä¸»ä»å¤åˆ¶é…ç½®
- è¯»å†™åˆ†ç¦»éƒ¨ç½²
- è‡ªåŠ¨æ•…éšœè½¬ç§»

---

## ğŸ†˜ åº”æ€¥æ¢å¤æµç¨‹

### 1. æ•…éšœè¯„ä¼°
1. ç¡®è®¤æ•…éšœç±»å‹å’Œå½±å“èŒƒå›´
2. è¯„ä¼°æ•°æ®ä¸¢å¤±ç¨‹åº¦
3. é€‰æ‹©åˆé€‚çš„æ¢å¤ç­–ç•¥

### 2. å¿«é€Ÿæ¢å¤
```bash
# åœæ­¢åº”ç”¨æœåŠ¡
sudo systemctl stop nginx
sudo systemctl stop supervisor

# å¤‡ä»½å½“å‰æŸåæ–‡ä»¶
mv db.sqlite3 db.sqlite3.damaged_$(date +%Y%m%d_%H%M%S)

# æ¢å¤æœ€æ–°å¤‡ä»½
python manage.py db_restore --file=backups/full/latest_backup.sqlite3

# éªŒè¯æ•°æ®å®Œæ•´æ€§
python manage.py db_restore --verify

# é‡å¯æœåŠ¡
sudo systemctl start supervisor
sudo systemctl start nginx
```

### 3. åç»­å¤„ç†
1. åˆ†ææ•…éšœåŸå› 
2. æ›´æ–°å¤‡ä»½ç­–ç•¥
3. åŠ å¼ºé¢„é˜²æªæ–½

---

## ğŸ“ è”ç³»ä¿¡æ¯

**è¿ç»´å›¢é˜Ÿ**: ops@greaterwms.com  
**æŠ€æœ¯æ”¯æŒ**: tech@greaterwms.com  
**ç´§æ€¥è”ç³»**: +86-xxx-xxxx-xxxx

---

## ğŸ“ å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å†…å®¹ | ä¿®æ”¹äºº |
|------|------|----------|--------|
| 1.0 | 2024-01-01 | åˆå§‹ç‰ˆæœ¬ | Admin |
| 1.1 | 2024-02-01 | æ·»åŠ Dockeré…ç½® | DevOps |
| 1.2 | 2024-03-01 | å®Œå–„ç›‘æ§å‘Šè­¦ | SRE |

---

*æœ€åæ›´æ–°: 2024å¹´1æœˆ*  
*ç»´æŠ¤è€…: GreaterWMSè¿ç»´å›¢é˜Ÿ*
